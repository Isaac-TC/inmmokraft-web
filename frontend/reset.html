<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Restablecer contraseña</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex align-items-center justify-content-center vh-100">
  <div class="card p-4 shadow-lg rounded-4 text-center" style="width: 100%; max-width: 400px;">
    <h3 class="mb-3">Restablecer contraseña</h3>
    <input type="password" id="nuevaClave" class="form-control mb-3" placeholder="Nueva contraseña">
    <button onclick="enviarNuevaClave()" class="btn btn-success">Actualizar</button>
  </div>

  <script>
    function obtenerParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        token: params.get("token"),
        correo: params.get("email")
      };
    }

    async function enviarNuevaClave() {
      const { token, correo } = obtenerParams();
      const nuevaClave = document.getElementById("nuevaClave").value;

      if (!nuevaClave) return alert("Ingresa una nueva contraseña");

      try {
        const res = await fetch("http://localhost:3000/api/resetear", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ correo, token, nuevaClave })
        });

        const data = await res.json();
        if (data.success) {
          alert("Contraseña actualizada. Inicia sesión.");
          window.location.href = "Login.html";
        } else {
          alert("Token inválido o expirado.");
        }
      } catch (e) {
        alert("Error al procesar la solicitud.");
        console.error(e);
      }
    }

    const usuarios = {};  // Simula base de datos

// 1. Endpoint para solicitar recuperación
app.post('/api/recuperar', async (req, res) => {
  const { correo } = req.body;
  if (!correo) return res.status(400).json({ success: false });

  const token = crypto.randomBytes(20).toString('hex');
  usuarios[correo] = { token, expiracion: Date.now() + 3600000 }; // 1h

  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: 'tu_correo@gmail.com',
      pass: 'tu_contraseña_app'
    }
  });

  const url = `http://localhost:5501/frontend/reset.html?token=${token}&email=${encodeURIComponent(correo)}`;

  const mailOptions = {
    from: 'tu_correo@gmail.com',
    to: correo,
    subject: 'Recuperar contraseña',
    html: `<p>Haz clic aquí para restablecer tu contraseña: <a href="${url}">Recuperar</a></p>`
  };

  try {
    await transporter.sendMail(mailOptions);
    res.json({ success: true });
  } catch (err) {
    console.error('Error al enviar correo:', err);
    res.status(500).json({ success: false });
  }
});

// 2. Endpoint para cambiar contraseña
app.post('/api/resetear', (req, res) => {
  const { correo, token, nuevaClave } = req.body;
  const usuario = usuarios[correo];

  if (!usuario || usuario.token !== token || Date.now() > usuario.expiracion) {
    return res.status(400).json({ success: false, message: 'Token inválido o expirado' });
  }

  // Aquí guardarías la nueva contraseña en tu base de datos real
  console.log(`Contraseña actualizada para ${correo}: ${nuevaClave}`);

  delete usuarios[correo];
  res.json({ success: true });
});

app.listen(3000, () => {
  console.log('Servidor corriendo en http://localhost:3000');
});
  </script>
  
</body>
</html>
